#Team_ Project #Database Creation file
#Notes: If changes need to be made to design, please add comment and make change in database design: https://lucid.app/lucidchart/7184eecd-2be3-4a9c-980e-153cd7cb40c1/edit?invitationId=inv_97aa72d9-8241-4889-939a-19b138899679&page=0_0#
#
#
##############################################################################################
CREATE DATABASE IF NOT EXISTS group_project_team8;
USE group_project_team8;


DROP TABLE IF EXISTS Crop_Info;
CREATE TABLE Crop_Info (
cropID int NOT NULL,
cropName char(35) NOT NULL,
cropFamily char(35) NOT NULL,
CONSTRAINT cropInfoPK PRIMARY KEY (cropID),
CONSTRAINT cropNameAK UNIQUE (cropName),
CONSTRAINT cropFamilyValues CHECK (cropFamily in ('Alliaceae','non-rotation crop','Solanaceae','Umbelliferea','Cucurbits','Chenopodiaceae','Legumes','Brassicas'))
);

--
-- Table structure for table Season
--

DROP TABLE IF EXISTS Season;

CREATE TABLE Season (
seasonID int NOT NULL,
seasonName char(10) NOT NULL,
CONSTRAINT seasonPK PRIMARY KEY (seasonID),
UNIQUE KEY seasonAK (seasonName),
CONSTRAINT seasonValues CHECK (seasonName in ('Spring','Summer','Fall','Winter','Year Round'))
);

--
-- Table structure for table Crop_Season
--

DROP TABLE IF EXISTS Crop_Season;
CREATE TABLE Crop_Season (
cropSeasonID int NOT NULL,
cropID int NOT NULL,
seasonID int NOT NULL,
soilType char(10) NOT NULL,
sunNeeds char(10) NOT NULL,
CONSTRAINT Crop_SeasonPK PRIMARY KEY (cropSeasonID),
CONSTRAINT Crop_InfoFK FOREIGN KEY (cropID) REFERENCES Crop_Info (cropID),
CONSTRAINT SeasonFK FOREIGN KEY (seasonID) REFERENCES Season (seasonID),
CONSTRAINT sunNeedsValues CHECK (sunNeeds in ('partial','full'))
);

--
-- Table structure for table Garden
--
Create TABLE Garden (
gardenID INT NOT NULL,
gardenLocation Char(30),
CONSTRAINT gardenPK PRIMARY KEY (gardenID)
);

CREATE TABLE Bed (
    bedNO char(5) NOT NULL,
    size decimal(10, 2) NOT NULL,
    soilType char(10) NOT NULL,
    gardenID INT NOT NULL,
    CONSTRAINT bedPK PRIMARY KEY (bedNO),
    CONSTRAINT bedSize CHECK (size > 0),
    CONSTRAINT bedSoilType CHECK (soilType IN ('sand-loamy', 'silt-loamy', 'sandy', 'loamy','clay-loamy','clay')),
    CONSTRAINT gardenFK FOREIGN KEY (gardenID) REFERENCES Garden (gardenID)
);

DROP TABLE IF EXISTS Current_Crops;

CREATE TABLE Current_Crops (
cropSeasonID int NOT NULL,
cropName char(35) NOT NULL,
plantStatus char(25) DEFAULT NULL,
cropID int NOT NULL,
semesterPlanted char(10) not null,
yearPlanted int not null,
CONSTRAINT currentCropPK PRIMARY KEY (cropName),
CONSTRAINT cropIdFK FOREIGN KEY (cropID) REFERENCES Crop_Info (cropID),
constraint semesterCheck check (semesterPlanted in ('Spring', 'Summer', 'Fall'))
);



#Add club member table 
Create table club_member(
userID	int not null auto_increment,
userType char(10) not null,
lastName char(35) 	not null,
firstName char(35)	not null,
phoneNumber	int 	null,
email		char(35) null,
constraint 	ClubMemberPK primary key (userID),
constraint 	ClubMemberAK unique (phoneNumber),
constraint userTypeCheck Check (userType in ('Advisor','Officer','Reserver','Member'))
);

#Add reservation
create table Reservation (
userID int not null,
bedNo char(5) not null,
semesterAssigned date not null,
constraint ReservationPK primary key (userID, bedNo),
constraint ReservationFK foreign key (bedNo) references Bed(bedNO)
	ON UPDATE CASCADE ON DELETE RESTRICT,
constraint ReservationFK2 foreign key (userID) references club_member(userID)
	ON UPDATE CASCADE ON DELETE RESTRICT
);

#Add item table
create table item (
itemID int not null auto_increment,
itemName char(35)	not null,
itemType 	char(15)	null,
constraint itemPK primary key (itemID)
);

#add inventory table
create table inventory (
inventoryID int not null auto_increment,
quantity int null,
gardenID INT NOT NULL,
itemID int not null,
constraint inventoryPK primary key (inventoryID),
constraint inventoryFK1 foreign key (itemID) references item(itemID),
constraint inventoryFK2 foreign key (gardenID) references Garden(gardenID)
	ON UPDATE CASCADE ON DELETE RESTRICT
);

#add inventory trans
create table inventoryTrans ( 
transactionNo int not null auto_increment,
quantityChange	int not null,
datePurchased	date not null,
price 	double	not null,
itemID int not null,
inventoryID int not null,
constraint inventoryTransPK primary key (transactionNo),
constraint inventoryTransFK foreign key	(itemID) references item(itemID)
	ON UPDATE CASCADE ON DELETE RESTRICT,
constraint inventoryTransFK2 foreign key (inventoryID) references inventory(inventoryID)
	ON UPDATE CASCADE ON DELETE RESTRICT
);

#User Defined functions: 

#Function that returns # of club members with/without reservations  
Delimiter %%

CREATE FUNCTION membersWithCurrentReservation()
RETURNS INT 
DETERMINISTIC 
BEGIN 
  DECLARE reserved INT; 

  SELECT COUNT(DISTINCT userID) 
  INTO reserved
  From RESERVATION;

  RETURN reservation; 

END %% 

Delimiter ; 

DELIMITER %%

CREATE FUNCTION membersWithNoCurrentReservation()
RETURNS INT 
DETERMINISTIC 
BEGIN 
  DECLARE notReserved INT; 

  SELECT COUNT(*) 
  INTO notReserved 
  FROM ClubMember
  WHERE userID 
        NOT IN(
          SELECT userID FROM Reservation
        ); 

  RETURN notReserved; 

END %% 

#add a function named Semester that will concat semesterPlanted and yearPlanted to become one column 
#for example: carrots | fall | 2025 -> carrots | fall 2025

DELIMITER %%
CREATE FUNCTION Semester(semester VARCHAR (8), year INT)
RETURNS VARCHAR(15)
DETERMINISTIC 
BEGIN 
  RETURN CONCAT (semester, ' ' , year); 
END%%

Delimiter ; 

#Stored Procedures: 
# Select statement that displays all the crops and their corresponding count of the crops that are planted in a particular garden

DELIMITER %%

CREATE PROCEDURE CurrentCropsInGardensReport()
BEGIN
  SELECT 
  g.gardenID, 
  g.gardenLocation,
  b.bedNO,
  ci.cropName, 
  s.seasonName as seasonality,
  Count(*) as cropCount
  From Current_Crops AS cc

  JOIN Bed AS b 
    ON cc.bedNO = b.bedNO
  JOIN Garden AS g 
    ON b.gardenID = g.gardenID
  JOIN Crop_Season as cs
    ON cc.cropID = cs.CropID AND cc.seasonID = cs.seasonID
  JOIN Crop_Info AS ci 
    ON cs.CropID = ci.cropID
  JOIN Season AS S
    ON cs.SeasonID = S.SeasonID
  GROUP BY g.gardenID, g.gardenLocation, b.bedNO, ci.cropName, s.seasonName
  ORDER BY g.gardenID, b.bedNO, cropCount DESC;

END %%


DELIMITER ;


 #Select statement that displays the beds which are not reserved (displays size, soilType, but NOT status)
DELIMITER %%

CREATE PROCEDURE UnreservedBeds()
BEGIN
  SELECT
    b.bedNo, 
    b.gardenID, 
    g.gardenLocation, 
    b.size, 
    b.soilType,  
    b.bedStatus
  FROM Bed as b
  JOIN Garden as g
    ON b.gardenID = g.gardenID
  LEFT JOIN Reservation AS r  
    ON b.bedNO = r.bedNO
  WHERE r.bedNO IS NULL;

END %%

DELIMITER ; 


  


#Select statement that displays low stock inventory items with (less than 3 in inventory)
DELIMITER %% 

CREATE PROCEDURE LowStockItems()
BEGIN
  SELECT
    i.itemName,
    inv.gardenID,
    inv.quantity 
  FROM inventory as inv
  JOIN item as i 
    ON inv.itemID = i.itemID
  WHERE inv.quantity < 3 
  ORDER BY inv.quantity ASC; 
END %%

DELIMITER ; 
  


#Select statement that displays the last 1o inventory transactions
DELIMITER %%
CREATE PROCEDURE Last10InventoryTransactions()
  BEGIN 
  SELECT
    t.transactionNo, 
    t.quantityChange,     
    t.datePurchased,
    t.price,
    i.itemName
FROM 
  inventoryTrans AS t
  JOIN item as i on t.itemID = i.itemID
  ORDER BY t.transactionNo DESC
  LIMIT 10; 

END %% 

DELIMITER ; 

DELIMITER %%

create view ClubMemberView (cropName, bedNo, gardenName, semesterPlanted, yearPlanted)
as select c.cropName, b.bedNo, g.gardenID, c.semesterPlanted, c.yearPlanted
from current_Crops c, Bed b, Garden g
where bedStatus != 'Reserved'
group by b.bedNo;


create view CurrentCropView (cropName, bedNo, gardenName, semesterPlanted, yearPlanted)
as select c.cropName, b.bedNo, g.gardenID, c.semesterPlanted, c.yearPlanted
from Current_Crops c, Bed b, Garden g
group by b.bedNo;

create view OfficerViewInventory (itemName, quanity, gardenName)
as select i.itemName, iv.quantity, g.gardenID
from item i, inventory iv, Garden g
group by g.gardenID;

create view AdvisorInventoryTransView (itemName, quanity, gardenName, datePurchased, price)
as select i.itemName, iv.quantity, g.gardenID, ivt.datePurchased, ivt.price
from item i, inventory iv, Garden g, inventoryTrans ivt
group by g.gardenID;


