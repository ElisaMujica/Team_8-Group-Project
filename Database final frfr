#Team_8 Project #Database Creation file

CREATE DATABASE IF NOT EXISTS group_project_team8;
USE group_project_team8;

##############################################################################################

DROP TABLE IF EXISTS Crop_Info;
CREATE TABLE Crop_Info (
    cropID int NOT NULL AUTO_INCREMENT,
    cropName char(35) NOT NULL,
    cropFamily char(35) NOT NULL,
    CONSTRAINT cropInfoPK PRIMARY KEY (cropID),
    CONSTRAINT cropNameAK UNIQUE (cropName),
    CONSTRAINT cropFamilyValues CHECK (cropFamily in ('Alliaceae','non-rotation crop','Solanaceae','Umbelliferea','Cucurbits','Chenopodiaceae','Legumes','Brassicas'))
);


DROP TABLE IF EXISTS Season;
CREATE TABLE Season (
    seasonID int NOT NULL,
    seasonName char(10) NOT NULL,
    CONSTRAINT seasonPK PRIMARY KEY (seasonID),
    UNIQUE KEY seasonAK (seasonName),
    CONSTRAINT seasonValues CHECK (seasonName in ('Spring','Summer','Fall','Winter','Year Round'))
);


DROP TABLE IF EXISTS Crop_Season;
CREATE TABLE Crop_Season (
    cropSeasonID int NOT NULL AUTO_INCREMENT,
    cropID int NOT NULL,
    seasonID int NOT NULL,
    soilType char(10) NOT NULL,
    sunNeeds char(10) NOT NULL,
    CONSTRAINT Crop_SeasonPK PRIMARY KEY (cropSeasonID),
    CONSTRAINT Crop_InfoFK FOREIGN KEY (cropID) REFERENCES Crop_Info (cropID),
    CONSTRAINT SeasonFK FOREIGN KEY (seasonID) REFERENCES Season (seasonID),
    CONSTRAINT sunNeedsValues CHECK (sunNeeds in ('partial','full')),
    CONSTRAINT CropSeasonSoilTypeCheck CHECK (soilType IN ('sand-loamy', 'silt-loamy', 'sandy', 'loamy','clay-loamy','clay'))
);

DROP TABLE IF EXISTS Garden;
CREATE TABLE Garden (
    gardenID INT NOT NULL,
    gardenLocation Char(30),
    CONSTRAINT gardenPK PRIMARY KEY (gardenID)
);


DROP TABLE IF EXISTS Bed;
CREATE TABLE Bed (
    bedNO char(5) NOT NULL,
    size decimal(10, 2) NOT NULL,
    soilType char(10) NOT NULL,
    gardenID INT NOT NULL,
    CONSTRAINT bedPK PRIMARY KEY (bedNO),
    CONSTRAINT bedSize CHECK (size > 0),
    CONSTRAINT bedSoilType CHECK (soilType IN ('sand-loamy', 'silt-loamy', 'sandy', 'loamy','clay-loamy','clay')),
    CONSTRAINT gardenFK FOREIGN KEY (gardenID) REFERENCES Garden (gardenID)
);


DROP TABLE IF EXISTS Current_Crops;
CREATE TABLE Current_Crops (
    currentCropID INT NOT NULL AUTO_INCREMENT,
    bedNO CHAR(5) NOT NULL,
    cropSeasonID INT NOT NULL,
    plantStatus CHAR(25),
    semesterPlanted CHAR(10) NOT NULL,
    yearPlanted INT NOT NULL,
    CONSTRAINT CurrentCropsPK PRIMARY KEY (currentCropID),
    CONSTRAINT CurrentCropsBedFK FOREIGN KEY (bedNO) REFERENCES Bed(bedNO)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT CurrentCropsCropSeasonFK FOREIGN KEY (cropSeasonID) REFERENCES Crop_Season(cropSeasonID)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT SemesterCheck CHECK (semesterPlanted IN ('Spring','Summer','Fall'))
);


DROP TABLE IF EXISTS club_member;
CREATE TABLE club_member (
    userID int NOT NULL AUTO_INCREMENT,
    userType char(10) NOT NULL,
    lastName char(35) NOT NULL,
    firstName char(35) NOT NULL,
    phoneNumber VARCHAR(15) UNIQUE,
    email char(35) NULL,
    CONSTRAINT ClubMemberPK PRIMARY KEY (userID),
    CONSTRAINT ClubMemberAK UNIQUE (phoneNumber),
    CONSTRAINT userTypeCheck CHECK (userType in ('Advisor','Officer','Reserver','Member'))
);


DROP TABLE IF EXISTS Reservation;
CREATE TABLE Reservation (
    userID int NOT NULL,
    bedNo char(5) NOT NULL,
    semesterAssigned date NOT NULL,
    CONSTRAINT ReservationPK PRIMARY KEY (userID, bedNo),
    CONSTRAINT ReservationFK FOREIGN KEY (bedNo) REFERENCES Bed(bedNO)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT ReservationFK2 FOREIGN KEY (userID) REFERENCES club_member(userID)
        ON UPDATE CASCADE ON DELETE RESTRICT
);


DROP TABLE IF EXISTS item;
CREATE TABLE item (
    itemID int NOT NULL AUTO_INCREMENT,
    itemName char(35) NOT NULL,
    itemType char(15) NULL,
    CONSTRAINT itemPK PRIMARY KEY (itemID)
);


DROP TABLE IF EXISTS inventory;
CREATE TABLE inventory (
    inventoryID int NOT NULL AUTO_INCREMENT,
    quantity int NULL,
    gardenID INT NOT NULL,
    itemID int NOT NULL,
    CONSTRAINT inventoryPK PRIMARY KEY (inventoryID),
    CONSTRAINT inventoryFK1 FOREIGN KEY (itemID) REFERENCES item(itemID),
    CONSTRAINT inventoryFK2 FOREIGN KEY (gardenID) REFERENCES Garden(gardenID)
        ON UPDATE CASCADE ON DELETE RESTRICT
);


DROP TABLE IF EXISTS inventoryTrans;
CREATE TABLE inventoryTrans (
    transactionNo int NOT NULL AUTO_INCREMENT,
    quantityChange int NOT NULL,
    datePurchased date NOT NULL,
    price double NOT NULL,
    itemID int NOT NULL,
    inventoryID int NOT NULL,
    CONSTRAINT inventoryTransPK PRIMARY KEY (transactionNo),
    CONSTRAINT inventoryTransFK FOREIGN KEY (itemID) REFERENCES item(itemID)
        ON UPDATE CASCADE ON DELETE RESTRICT,
    CONSTRAINT inventoryTransFK2 FOREIGN KEY (inventoryID) REFERENCES inventory(inventoryID)
        ON UPDATE CASCADE ON DELETE RESTRICT
);


DELIMITER %%
CREATE FUNCTION membersWithCurrentReservation()
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE reserved INT;

    SELECT COUNT(DISTINCT userID) INTO reserved
    FROM Reservation;

    RETURN reserved;
END %%
DELIMITER ;

DELIMITER %%
CREATE FUNCTION membersWithNoCurrentReservation()
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE notReserved INT;

    SELECT COUNT(*) INTO notReserved
    FROM club_member
    WHERE userID NOT IN (SELECT userID FROM Reservation);

    RETURN notReserved;
END %%
DELIMITER ;

DELIMITER %%
CREATE FUNCTION Semester(semester VARCHAR(8), year INT)
RETURNS VARCHAR(15)
DETERMINISTIC
BEGIN
    RETURN CONCAT(semester, ' ', year);
END %%
DELIMITER ;

DELIMITER %%
CREATE PROCEDURE CurrentCropsInGardensReport()
BEGIN
    SELECT 
        g.gardenID,
        g.gardenLocation,
        b.bedNO,
        ci.cropName,
        s.seasonName AS seasonality,
        COUNT(*) AS cropCount
    FROM Current_Crops AS cc
    JOIN Bed AS b ON cc.bedNO = b.bedNO
    JOIN Garden AS g ON b.gardenID = g.gardenID
    JOIN Crop_Season AS cs ON cc.cropSeasonID = cs.cropSeasonID
    JOIN Crop_Info AS ci ON cs.cropID = ci.cropID
    JOIN Season AS s ON cs.seasonID = s.seasonID
    GROUP BY g.gardenID, g.gardenLocation, b.bedNO, ci.cropName, s.seasonName
    ORDER BY g.gardenID, b.bedNO, cropCount DESC;
END %%
DELIMITER ;

DELIMITER %%
CREATE PROCEDURE UnreservedBeds()
BEGIN
    SELECT
        b.bedNo,
        b.gardenID,
        g.gardenLocation,
        b.size,
        b.soilType
    FROM Bed AS b
    JOIN Garden AS g ON b.gardenID = g.gardenID
    LEFT JOIN Reservation AS r ON b.bedNO = r.bedNO
    WHERE r.bedNO IS NULL;
END %%
DELIMITER ;

DELIMITER %%
CREATE PROCEDURE LowStockItems()
BEGIN
    SELECT
        i.itemName,
        inv.gardenID,
        inv.quantity
    FROM inventory AS inv
    JOIN item AS i ON inv.itemID = i.itemID
    WHERE inv.quantity < 3
    ORDER BY inv.quantity ASC;
END %%
DELIMITER ;

DELIMITER %%
CREATE PROCEDURE Last10InventoryTransactions()
BEGIN
    SELECT
        t.transactionNo,
        t.quantityChange,
        t.datePurchased,
        t.price,
        i.itemName
    FROM inventoryTrans AS t
    JOIN item AS i ON t.itemID = i.itemID
    ORDER BY t.transactionNo DESC
    LIMIT 10;
END %%
DELIMITER ;

-- Views

CREATE OR REPLACE VIEW GardenView AS
SELECT
    ci.cropName,
    b.bedNO,
    g.gardenLocation AS gardenName,
    c.semesterPlanted,
    c.yearPlanted,
    g.gardenID
FROM Current_Crops c
JOIN Bed b ON c.bedNO = b.bedNO
JOIN Garden g ON b.gardenID = g.gardenID
JOIN Crop_Season cs ON c.cropSeasonID = cs.cropSeasonID
JOIN Crop_Info ci ON cs.cropID = ci.cropID
ORDER BY b.bedNO;

CREATE OR REPLACE VIEW CurrentCropView AS
SELECT
    ci.cropName,
    b.bedNO,
    g.gardenLocation AS gardenName,
    c.semesterPlanted,
    c.yearPlanted
FROM Current_Crops c
JOIN Bed b ON c.bedNO = b.bedNO
JOIN Garden g ON b.gardenID = g.gardenID
JOIN Crop_Season cs ON c.cropSeasonID = cs.cropSeasonID
JOIN Crop_Info ci ON cs.cropID = ci.cropID
ORDER BY b.bedNO;

CREATE OR REPLACE VIEW OfficerViewInventory AS
SELECT
    i.itemName,
    iv.quantity,
    g.gardenLocation AS gardenName
FROM inventory iv
JOIN item i ON iv.itemID = i.itemID
JOIN Garden g ON iv.gardenID = g.gardenID
ORDER BY g.gardenLocation;

CREATE OR REPLACE VIEW AdvisorInventoryTransView AS
SELECT
    i.itemName,
    iv.quantity,
    g.gardenLocation AS gardenName,
    ivt.datePurchased,
    ivt.price
FROM inventoryTrans ivt
JOIN item i ON ivt.itemID = i.itemID
JOIN inventory iv ON ivt.inventoryID = iv.inventoryID
JOIN Garden g ON iv.gardenID = g.gardenID
ORDER BY ivt.datePurchased DESC, i.itemName;
